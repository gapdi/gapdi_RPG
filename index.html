<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VILLAIN HUNTER : MOBILE</title>
    <style>
        :root {
            --bg: #000; --surface: #0a0a0a; --border: #222;
            --text-main: #fff; --text-sub: #888;
            --rare: #aaa; --unique: #fff;
        }

        body { 
            background: var(--bg); color: var(--text-main); 
            font-family: -apple-system, sans-serif; 
            display: flex; justify-content: center; margin: 0; 
            touch-action: manipulation; /* 모바일 더블탭 방지 */
        }

        #game-container { 
            width: 100vw; min-height: 100vh; max-width: 500px;
            background: var(--surface); padding: 20px; 
            box-sizing: border-box; display: flex; flex-direction: column;
        }

        /* 스테이터스 바 - 상단 고정 느낌 */
        .status-header {
            display: flex; justify-content: space-between; align-items: center;
            padding: 15px; border: 1px solid var(--border); margin-bottom: 20px;
        }
        .stat-group { text-align: center; }
        .stat-label { font-size: 10px; color: var(--text-sub); display: block; margin-bottom: 4px; }
        .stat-value { font-size: 18px; font-weight: 700; }

        /* 진행도 */
        .stage-info { display: flex; justify-content: space-between; font-size: 12px; margin-bottom: 5px; color: var(--text-sub); }
        .progress-line { width: 100%; height: 2px; background: #111; margin-bottom: 20px; }
        #progress-fill { height: 100%; background: #fff; width: 0%; transition: width 0.4s; }

        /* 대칭 전투 유닛 (큼직하게) */
        .unit-display { margin-bottom: 30px; }
        .unit-label { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 10px; font-weight: bold; }
        .hp-bar-outer { width: 100%; height: 8px; background: #111; border-radius: 4px; overflow: hidden; }
        .hp-fill { height: 100%; background: #fff; width: 100%; transition: width 0.3s; }

        /* 빌런 정보 */
        .villain-box { text-align: center; padding: 40px 20px; border: 1px solid var(--border); margin-bottom: 20px; background: #050505; }
        #m-name { font-size: 26px; font-weight: 800; margin-bottom: 10px; }
        #m-skill { font-size: 14px; color: var(--text-sub); }

        /* 장비 그리드 (터치하기 쉽게 큼직하게) */
        .grid-system { 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            gap: 2px; background: var(--border); border: 1px solid var(--border); 
            margin-bottom: 20px; 
        }
        .slot { background: var(--surface); height: 70px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .slot span { font-size: 10px; color: var(--text-sub); margin-bottom: 5px; }
        .slot .name { font-size: 11px; text-align: center; font-weight: bold; width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        /* 컨트롤 버튼 */
        .btn-main { 
            background: #fff; color: #000; border: none; padding: 20px; 
            width: 100%; font-weight: 900; cursor: pointer; font-size: 16px; border-radius: 4px;
        }

        /* 로그 */
        #log-window { 
            flex-grow: 1; min-height: 80px; overflow-y: auto; font-size: 13px; color: #555; 
            margin-top: 20px; border-top: 1px solid #111; padding-top: 10px;
        }

        /* 등급 스타일 */
        .grade-rare { color: #aaa !important; text-decoration: underline; }
        .grade-unique { color: #fff !important; text-shadow: 0 0 10px #fff; }

        /* 모달 */
        .modal { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background: #000; z-index:100; flex-direction:column; padding:30px; box-sizing: border-box; }
        .book-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; overflow-y: auto; margin: 20px 0; }
        .book-item { font-size: 14px; color: #222; border-bottom: 1px solid #111; padding: 8px 0; }
        .book-item.unlocked { color: #fff; }
    </style>
</head>
<body>

<div id="game-container">
    <div class="status-header">
        <div class="stat-group"><span class="stat-label">LEVEL</span><span id="p-lv" class="stat-value">1</span></div>
        <div class="stat-group"><span class="stat-label">ATTACK</span><span id="p-atk-val" class="stat-value">10</span></div>
        <div class="stat-group"><span class="stat-label">COLLECT</span><span class="stat-value"><span id="col-count">0</span>/50</span></div>
    </div>

    <div class="stage-info"><span id="stage-text">STAGE 01</span><span id="p-hp-text">100/100</span></div>
    <div class="progress-line"><div id="progress-fill"></div></div>

    <div class="unit-display">
        <div id="m-card" class="villain-box">
            <div id="m-name">SEARCHING</div>
            <div id="m-skill">-</div>
        </div>
        <div class="unit-label"><span>VILLAIN</span><span id="m-hp-percent">100%</span></div>
        <div class="hp-bar-outer"><div id="m-hp-fill" class="hp-fill"></div></div>
    </div>

    <div class="unit-display">
        <div class="unit-label"><span>MY MENTAL</span></div>
        <div class="hp-bar-outer" style="height: 12px; background: #151515;"><div id="p-hp-fill" class="hp-fill"></div></div>
        <button class="btn-main" style="margin-top:20px;" onclick="usePotion()">RESTORE (PIZZA: <span id="pot-count">2</span>)</button>
    </div>

    <div class="grid-system">
        <div class="slot" id="slot-weapon"><span>WEAPON</span><div class="name">-</div></div>
        <div class="slot" id="slot-hat"><span>HAT</span><div class="name">-</div></div>
        <div class="slot" id="slot-top"><span>TOP</span><div class="name">-</div></div>
        <div class="slot" id="slot-bottom"><span>BOTTOM</span><div class="name">-</div></div>
        <div class="slot" id="slot-glove"><span>GLOVE</span><div class="name">-</div></div>
        <div class="slot" id="slot-neck"><span>NECK</span><div class="name">-</div></div>
        <div class="slot" id="slot-wrist"><span>WRIST</span><div class="name">-</div></div>
        <div class="slot" onclick="toggleBook()" style="cursor:pointer; background:#111;"><span>ARCHIVE</span><div class="name" style="color:#fff">OPEN</div></div>
    </div>

    <div id="log-window"></div>

    <div id="book-modal" class="modal">
        <div style="font-size: 24px; font-weight: 800; border-bottom: 1px solid #222; padding-bottom: 15px;">ARCHIVE</div>
        <div class="book-grid" id="book-grid"></div>
        <button class="btn-main" onclick="toggleBook()">CLOSE</button>
    </div>

    <div id="game-over" class="modal" style="justify-content: center; text-align: center;">
        <div style="font-size: 40px; font-weight: 900; margin-bottom: 10px;">FAILED</div>
        <p id="death-reason" style="color: var(--text-sub); font-size: 16px; margin-bottom: 40px;"></p>
        <button class="btn-main" onclick="location.reload()">TRY AGAIN</button>
    </div>
</div>

<script src="villains.js"></script>
<script src="items.js"></script>
<script>
    let p = { lv:1, hp:100, atk:10, pot:2, stage:0, book:{}, eq:{}, isBookOpen: false };
    let m = null;

    const init = () => { initBookUI(); spawn(); setInterval(tick, 1000); updateUI(); };

    const initBookUI = () => {
        const grid = document.getElementById('book-grid');
        grid.innerHTML = "";
        VILLAINS_DATA.flat().forEach(v => {
            const div = document.createElement('div');
            div.className = "book-item"; div.id = `book-${v.name}`;
            div.innerText = "???"; grid.appendChild(div);
        });
    };

    const toggleBook = () => {
        p.isBookOpen = !p.isBookOpen;
        document.getElementById('book-modal').style.display = p.isBookOpen ? 'flex' : 'none';
    };

    const getAtk = () => p.atk + Object.values(p.eq).reduce((a,b)=> (b.slot==='weapon'||b.slot==='glove')?a+b.val:a, 0);
    const getMaxHP = () => 100 + (p.lv*10) + Object.values(p.eq).reduce((a,b)=> (['top','bottom','hat','wrist'].includes(b.slot))?a+b.val:a, 0);

    const spawn = () => {
        const raw = VILLAINS_DATA[p.stage][Math.floor(Math.random()*10)];
        const g = 1+(p.lv*0.15);
        m = { ...raw, curHp: Math.floor(raw.hp*g), maxHp: Math.floor(raw.hp*g), curAtk: Math.floor(raw.atk*g) };
        const card = document.getElementById('m-card');
        const nameEl = document.getElementById('m-name');
        if(m.isBoss) { card.style.borderColor = '#fff'; nameEl.style.color = '#fff'; } 
        else { card.style.borderColor = ''; nameEl.style.color = ''; }
        updateUI();
    };

    const tick = () => {
        if(p.hp <= 0 || p.isBookOpen) return;
        m.curHp -= getAtk();
        if(m.curHp <= 0) { win(); return; }
        p.hp -= m.curAtk;
        if(p.hp <= 0) { 
            document.getElementById('death-reason').innerText = `"${m.killMsg}"`;
            document.getElementById('game-over').style.display = 'flex'; 
        }
        updateUI();
    };

    const win = () => {
        p.book[m.name] = true; p.lv++; p.atk += 2;
        const bookEl = document.getElementById(`book-${m.name}`);
        if(bookEl) { bookEl.innerText = m.name; bookEl.classList.add('unlocked'); }
        
        const drop = ITEM_SYSTEM.generateDrop(m, p.stage);
        if(drop && (!p.eq[drop.slot] || p.eq[drop.slot].val < drop.val)) {
            p.eq[drop.slot] = drop;
            addLog(`GET: ${drop.name}`);
        }
        if(Math.random()<0.5) p.pot++;
        if(VILLAINS_DATA[p.stage].every(v=>p.book[v.name]) && p.stage < 4) p.stage++;
        spawn();
    };

    const usePotion = () => {
        if(p.pot<=0) return;
        p.pot--; p.hp = Math.min(getMaxHP(), p.hp + Math.floor(getMaxHP()*0.5));
        addLog("MENTAL RECOVERY");
        updateUI();
    };

    const addLog = (msg) => {
        const log = document.getElementById('log-window');
        const d = document.createElement('div'); d.innerText = `> ${msg}`;
        log.insertBefore(d, log.firstChild);
        if(log.childNodes.length > 5) log.lastChild.remove();
    };

    const updateUI = () => {
        const max = getMaxHP();
        document.getElementById('p-lv').innerText = p.lv;
        document.getElementById('p-atk-val').innerText = getAtk();
        document.getElementById('p-hp-text').innerText = `${Math.max(0,p.hp)} / ${max}`;
        document.getElementById('p-hp-fill').style.width = (p.hp/max*100) + "%";
        
        document.getElementById('m-name').innerText = m.name;
        document.getElementById('m-skill').innerText = m.skill;
        const mPercent = Math.max(0, Math.floor((m.curHp/m.maxHp)*100));
        document.getElementById('m-hp-percent').innerText = `${mPercent}%`;
        document.getElementById('m-hp-fill').style.width = mPercent + "%";
        
        document.getElementById('col-count').innerText = Object.keys(p.book).length;
        document.getElementById('progress-fill').style.width = (Object.keys(p.book).length/50*100) + "%";
        document.getElementById('pot-count').innerText = p.pot;
        document.getElementById('stage-text').innerText = `STAGE 0${p.stage + 1}`;

        ITEM_SYSTEM.slots.forEach(s => {
            const el = document.getElementById(`slot-${s}`);
            const nameEl = el.querySelector('.name');
            if(p.eq[s]) { 
                nameEl.innerText = p.eq[s].name;
                nameEl.className = `name grade-${p.eq[s].grade}`;
            }
        });
    };
    window.onload = init;
</script>
</body>
</html>