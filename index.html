<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>VILLAIN HUNTER : NOIR</title>
    <style>
        :root {
            --bg: #000; --surface: #0a0a0a; --border: #222;
            --text-main: #fff; --text-sub: #555;
            --rare: #aaa; --unique: #fff;
        }

        body { 
            background: var(--bg); color: var(--text-main); 
            font-family: 'Inter', -apple-system, sans-serif; 
            display: flex; justify-content: center; padding: 20px; margin: 0; 
        }

        #game-container { 
            width: 400px; background: var(--surface); 
            border: 1px solid var(--border); padding: 25px; 
            position: relative; box-sizing: border-box;
        }

        /* 헤더 섹션 */
        header { margin-bottom: 25px; }
        .status-row { display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 8px; }
        .stage-title { font-size: 10px; color: var(--text-sub); letter-spacing: 1px; text-transform: uppercase; }
        .collection-count { font-size: 18px; font-weight: 300; }
        .progress-line { width: 100%; height: 1px; background: #111; }
        #progress-fill { height: 100%; background: #fff; width: 0%; transition: width 0.4s; }

        /* 대칭 전투 유닛 */
        .combat-unit { margin-bottom: 20px; }
        .unit-info { display: flex; justify-content: space-between; font-size: 10px; margin-bottom: 6px; text-transform: uppercase; color: var(--text-sub); }
        .hp-bar-outer { width: 100%; height: 2px; background: #111; overflow: hidden; }
        .hp-fill { height: 100%; background: #fff; width: 100%; transition: width 0.3s; }

        /* 빌런 정보 카드 */
        .villain-card { text-align: center; padding: 25px 0; border: 1px solid transparent; margin-bottom: 15px; }
        .boss-active { border: 1px solid #333; background: #050505; }
        #m-name { font-size: 18px; font-weight: 600; margin-bottom: 4px; }
        #m-skill { font-size: 11px; color: var(--text-sub); }

        /* 장비 및 도감 그리드 (2x4 구성) */
        .grid-system { 
            display: grid; grid-template-columns: repeat(4, 1fr); 
            gap: 1px; background: var(--border); border: 1px solid var(--border); 
            margin: 25px 0; 
        }
        .slot { background: var(--surface); height: 50px; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .slot span { font-size: 8px; color: var(--text-sub); margin-bottom: 2px; }
        .slot .name { font-size: 9px; text-align: center; color: #444; max-width: 90%; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* 도감(Archive) 전용 버튼 슬롯 */
        .btn-archive { cursor: pointer; background: #111 !important; transition: 0.2s; }
        .btn-archive:hover { background: #1a1a1a !important; }

        /* 등급별 색상 */
        .grade-rare { color: #eee !important; text-decoration: underline; }
        .grade-unique { color: #fff !important; font-weight: 900; }

        /* 컨트롤 버튼 */
        .btn-main { background: #fff; color: #000; border: none; padding: 14px; width: 100%; font-weight: 800; cursor: pointer; font-size: 12px; }

        /* 로그 창 (복구됨) */
        #log-window { 
            height: 70px; overflow-y: auto; font-size: 10px; color: #444; 
            margin-top: 20px; border-top: 1px solid #111; padding-top: 10px; line-height: 1.5;
        }

        /* 모달 시스템 */
        .modal { display: none; position: absolute; top:0; left:0; width:100%; height:100%; background: #000; z-index:100; flex-direction:column; padding:30px; box-sizing: border-box; }
        .book-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 6px; overflow-y: auto; margin: 15px 0; }
        .book-item { font-size: 10px; color: #222; border-bottom: 1px solid #111; padding: 4px 0; }
        .book-item.unlocked { color: #fff; }
    </style>
</head>
<body>

<div id="game-container">
    <div id="book-modal" class="modal">
        <div style="font-size: 18px; letter-spacing: 2px; border-bottom: 1px solid #222; padding-bottom: 10px;">ARCHIVE</div>
        <div class="book-grid" id="book-grid"></div>
        <button class="btn-main" onclick="toggleBook()" style="background:none; color:#fff; border:1px solid #333;">CLOSE</button>
    </div>

    <div id="game-over" class="modal" style="justify-content: center; text-align: center;">
        <div style="font-size: 24px; font-weight: 800;">LOST</div>
        <p id="death-reason" style="color: var(--text-sub); font-size: 11px; margin: 20px 0;"></p>
        <button class="btn-main" onclick="location.reload()">RETRY</button>
    </div>

    <header>
        <div class="status-row">
            <div id="stage-text" class="stage-title">Stage 01</div>
            <div class="collection-count"><span id="col-count">0</span><span style="color:#222">/50</span></div>
        </div>
        <div class="progress-line"><div id="progress-fill"></div></div>
    </header>

    <div id="m-card" class="villain-card">
        <div id="m-name">SEARCHING</div>
        <div id="m-skill">-</div>
        <div class="unit-info"><span>Target</span><span id="m-hp-percent">100%</span></div>
        <div class="hp-bar-outer"><div id="m-hp-fill" class="hp-fill"></div></div>
    </div>

    <div class="combat-unit">
        <div class="unit-info"><span>Mental LV.<span id="p-lv">1</span></span><span id="p-hp-text">100/100</span></div>
        <div class="hp-bar-outer"><div id="p-hp-fill" class="hp-fill"></div></div>
        <button class="btn-main" style="margin-top:10px;" onclick="usePotion()">RESTORE MENTAL (PIZZA: <span id="pot-count">2</span>)</button>
    </div>

    <div class="grid-system">
        <div class="slot" id="slot-weapon"><span>WEAPON</span><div class="name">-</div></div>
        <div class="slot" id="slot-hat"><span>HAT</span><div class="name">-</div></div>
        <div class="slot" id="slot-top"><span>TOP</span><div class="name">-</div></div>
        <div class="slot" id="slot-bottom"><span>BOTTOM</span><div class="name">-</div></div>
        <div class="slot" id="slot-glove"><span>GLOVE</span><div class="name">-</div></div>
        <div class="slot" id="slot-neck"><span>NECK</span><div class="name">-</div></div>
        <div class="slot" id="slot-wrist"><span>WRIST</span><div class="name">-</div></div>
        <div class="slot btn-archive" onclick="toggleBook()"><span>ARCHIVE</span><div class="name" style="color:#fff">OPEN</div></div>
    </div>

    <div id="log-window"></div>
</div>

<script src="villains.js"></script>
<script src="items.js"></script>
<script>
    let p = { lv:1, hp:100, atk:10, pot:2, stage:0, book:{}, eq:{}, isBookOpen: false };
    let m = null;

    const init = () => { initBookUI(); spawn(); setInterval(tick, 1000); updateUI(); };

    const initBookUI = () => {
        const grid = document.getElementById('book-grid');
        grid.innerHTML = "";
        VILLAINS_DATA.flat().forEach(v => {
            const div = document.createElement('div');
            div.className = "book-item"; div.id = `book-${v.name}`;
            div.innerText = "····"; grid.appendChild(div);
        });
    };

    const toggleBook = () => {
        p.isBookOpen = !p.isBookOpen;
        document.getElementById('book-modal').style.display = p.isBookOpen ? 'flex' : 'none';
    };

    const getAtk = () => p.atk + Object.values(p.eq).reduce((a,b)=> (b.slot==='weapon'||b.slot==='glove')?a+b.val:a, 0);
    const getMaxHP = () => 100 + (p.lv*10) + Object.values(p.eq).reduce((a,b)=> (['top','bottom','hat','wrist'].includes(b.slot))?a+b.val:a, 0);

    const spawn = () => {
        const raw = VILLAINS_DATA[p.stage][Math.floor(Math.random()*10)];
        const g = 1+(p.lv*0.15);
        m = { ...raw, curHp: Math.floor(raw.hp*g), maxHp: Math.floor(raw.hp*g), curAtk: Math.floor(raw.atk*g) };
        const card = document.getElementById('m-card');
        const nameEl = document.getElementById('m-name');
        if(m.isBoss) { card.classList.add('boss-active'); nameEl.style.color = '#fff'; } 
        else { card.classList.remove('boss-active'); nameEl.style.color = ''; }
        updateUI();
    };

    const tick = () => {
        if(p.hp <= 0 || p.isBookOpen) return;
        m.curHp -= getAtk();
        if(m.curHp <= 0) { win(); return; }
        p.hp -= m.curAtk;
        if(p.hp <= 0) { 
            document.getElementById('death-reason').innerText = m.killMsg;
            document.getElementById('game-over').style.display = 'flex'; 
        }
        updateUI();
    };

    const win = () => {
        p.book[m.name] = true; p.lv++; p.atk += 2;
        const bookEl = document.getElementById(`book-${m.name}`);
        if(bookEl) { bookEl.innerText = m.name; bookEl.classList.add('unlocked'); }
        
        const drop = ITEM_SYSTEM.generateDrop(m, p.stage);
        if(drop && (!p.eq[drop.slot] || p.eq[drop.slot].val < drop.val)) {
            p.eq[drop.slot] = drop;
            addLog(`ITEM: ${drop.name.toUpperCase()}`);
        }
        if(Math.random()<0.5) p.pot++;
        if(VILLAINS_DATA[p.stage].every(v=>p.book[v.name]) && p.stage < 4) p.stage++;
        spawn();
    };

    const usePotion = () => {
        if(p.pot<=0) return;
        p.pot--; p.hp = Math.min(getMaxHP(), p.hp + Math.floor(getMaxHP()*0.5));
        addLog("SYSTEM: MENTAL RECOVERY");
        updateUI();
    };

    const addLog = (msg) => {
        const log = document.getElementById('log-window');
        const d = document.createElement('div'); d.innerText = `> ${msg}`;
        log.insertBefore(d, log.firstChild);
        if(log.childNodes.length > 4) log.lastChild.remove();
    };

    const updateUI = () => {
        const max = getMaxHP();
        document.getElementById('p-lv').innerText = p.lv;
        document.getElementById('p-hp-text').innerText = `${Math.max(0,p.hp)}/${max}`;
        document.getElementById('p-hp-fill').style.width = (p.hp/max*100) + "%";
        document.getElementById('m-name').innerText = m.name;
        document.getElementById('m-skill').innerText = m.skill;
        const mPercent = Math.max(0, Math.floor((m.curHp/m.maxHp)*100));
        document.getElementById('m-hp-percent').innerText = `${mPercent}%`;
        document.getElementById('m-hp-fill').style.width = mPercent + "%";
        document.getElementById('col-count').innerText = Object.keys(p.book).length;
        document.getElementById('progress-fill').style.width = (Object.keys(p.book).length/50*100) + "%";
        document.getElementById('pot-count').innerText = p.pot;
        document.getElementById('stage-text').innerText = `Stage 0${p.stage + 1}`;

        ITEM_SYSTEM.slots.forEach(s => {
            const el = document.getElementById(`slot-${s}`);
            const nameEl = el.querySelector('.name');
            if(p.eq[s]) { 
                nameEl.innerText = p.eq[s].name;
                nameEl.className = `name grade-${p.eq[s].grade}`;
            }
        });
    };
    window.onload = init;
</script>
</body>
</html>